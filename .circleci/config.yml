defaults: &defaults
  docker:
    - image: gcr.io/planet-4-151612/p4-builder:develop
  working_directory:  /home/circleci/

version: 2

jobs:
  build-develop:
    <<: *defaults
    environment:
      APP_HOSTNAME: k8s.p4.greenpeace.org
      APP_HOSTPATH: base
      CLOUDSQL_INSTANCE: p4-develop-k8s
      CONTAINER_PREFIX: planet4-base
      GOOGLE_PROJECT_ID: planet-4-151612
      HELM_NAMESPACE: develop
      WP_DB_NAME: planet4-base_wordpress
      WP_TITLE: Greenpeace Base Development
    steps:
      - setup_remote_docker

      - run:
          name: Configure
          command: |
            ${HOME}/scripts/activate-gcloud-account.sh
            mkdir -p /tmp/workspace/var
            echo "${CIRCLE_BUILD_NUM}" > /tmp/workspace/var/circle-build-num

      - run:
          name: Build
          working_directory: /home/circleci
          command: |
            if make
            then
              TYPE="Build" ${HOME}/scripts/notify-job-success.sh
            else
              TYPE="Build" ${HOME}/scripts/notify-job-failure.sh
              exit 1
            fi

      - persist_to_workspace:
          root: /tmp/workspace
          paths:
            - var

  test-selenium:
    <<: *defaults
    steps:
      - run:
          name: Checkout Selenium Tests
          command: |
            git clone https://github.com/greenpeace/planet4-selenium-tests

      - run:
          name: Start docker-compose
          command: |
            sudo echo "127.0.0.1  test.planet4.dev" >> /etc/hosts
            git clone https://github.com/greenpeace/planet4-docker-compose
            pushd planet4-docker-compose
            APP_IMAGE=gcr.io/planet-4-151612/planet4-base-app:build-${CIRCLE_BUILD_NUM} \
            OPENRESTY_IMAGE=gcr.io/planet-4-151612/planet4-base-openresty:build-${CIRCLE_BUILD_NUM} \
            docker-compose -f docker-compose.stateless.yml up -d
            popd

      - run:
          name: Wait until containers are ready
          command: |
            # 2 seconds * 150 == 5+ minutes
            interval=2
            loop=150

            # Number of consecutive successes to qualify as 'up'
            threshold=2
            success=0
            until [[ $success -ge $threshold ]]
            do
              # Curl to container and expect status code 200
              set +e
              docker run --network "container:planet4docker_compose_openresty_1" --rm appropriate/curl -s -k "http://localhost:80" | grep -q "greenpeace"

              if [[ $? -eq 0 ]]
              then
                success=$((success+1))
                echo "Success: $success/$threshold"
              else
                success=0
              fi
              set -e

              loop=$((loop-1))
              if [[ $loop -lt 1 ]]
              then
                >&2 echo "[ERROR] Timeout waiting for docker-compose to start"
                >&2 docker-compose -p build logs
                exit 1
              fi

              [[ $success -ge $threshold ]] || sleep $interval
            done

      - run:
          name: Run Selenium Tests
          command: |
            docker run --network "container:planet4docker_compose_openresty_1" --rm appropriate/curl -s -k "http://localhost:80" | grep "greenpeace"

  deploy-develop:
    <<: *defaults
    environment:
      APP_HOSTNAME: k8s.p4.greenpeace.org
      APP_HOSTPATH: base
      CLOUDSQL_INSTANCE: p4-develop-k8s
      CONTAINER_PREFIX: planet4-base
      GOOGLE_PROJECT_ID: planet-4-151612
      HELM_NAMESPACE: develop
      WP_DB_NAME: planet4-base_wordpress
      WP_TITLE: Greenpeace Base Development
    steps:
      - attach_workspace:
          at: /tmp/workspace

      - run:
          name: Configure
          command: |
            ${HOME}/scripts/activate-gcloud-account.sh

      - run:
          name: Deploy new containers
          environment:
            NEWRELIC_APPNAME: P4 base Development
          command: |
            BUILD_TAG="build-$(cat /tmp/workspace/var/circle-build-num)" \
            make deploy

workflows:
  version: 2
  develop:
    jobs:
    - build-develop:
        context: org-global
        filters:
          branches:
            only: develop
          tags:
            ignore: /^v.*/
    - test-selenium:
        requires:
          - build-develop
        filters:
          branches:
            only: develop
            ignore: /^v.*/

    # - deploy-develop:
    #     context: org-global
    #     requires:
    #       - test
    #     filters:
    #       branches:
    #         only: develop
